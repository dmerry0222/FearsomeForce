<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>D&D Availability</title>

  <!-- Supabase JS (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:16px;
      --cell-radius:14px;

      --green:#22c55e;
      --blue:#3b82f6;
      --yellow:#f59e0b;
      --red:#ef4444;

      --darkBtn:#141b24;
      --darkBtnBorder: rgba(255,255,255,.12);
      --darkBtnHover: rgba(255,255,255,.06);

      --bestGlow: rgba(245, 158, 11, .18);  /* yellow-ish */
      --confirmGlow: rgba(34, 197, 94, .18); /* green-ish */
      --blockedFill: rgba(239, 68, 68, .10); /* red-ish */
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 50% -200px, #1f2937 0%, var(--bg) 55%, #05070a 100%);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 14px 14px 28px;
    }

    /* Banner */
    .banner{
      border-radius: var(--radius);
      padding: 14px 16px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      display:flex;
      align-items:flex-start;
      gap:12px;
      margin-bottom: 12px;
      transition: background .15s ease, border-color .15s ease;
    }

    .banner-left{
      min-width: 0;
      flex: 1 1 auto;
    }

    .banner-title{
      font-weight: 900;
      font-size: 20px;
      letter-spacing: .2px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .banner-subrow{
      margin-top: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .modebtn{
      flex: 1 1 160px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--darkBtnBorder);
      background: rgba(255,255,255,.03);
      color: #fff;
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .modebtn:hover{ background: var(--darkBtnHover); }
    .modebtn.active{
      background: var(--darkBtn);
      border-color: rgba(255,255,255,.18);
    }

    .icon{
      width: 18px;
      height: 18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      opacity: .95;
    }

    .banner-right{
      flex: 0 0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      margin-top: 2px;
    }

    .pill{
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      color: #fff;
      white-space: nowrap;
    }

    .pill-x{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: #fff;
      display:none;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight: 900;
      line-height: 1;
    }
    .pill-x:hover{ background: rgba(0,0,0,.26); }
    .pill-x:active{ transform: translateY(1px); }

    button.reset{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
    }
    button.reset:hover{ background: rgba(255,255,255,.14); }
    button.reset:active{ transform: translateY(1px); }
    button.reset:disabled{ opacity:.55; cursor:not-allowed; }

    /* Month header */
    .monthbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      margin: 12px 0;
      gap: 10px;
    }

    .month-title{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
      display:flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    .loading-tag{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      display:none;
      white-space: nowrap;
    }

    .navbtns{ display:flex; gap:8px; flex: 0 0 auto; }
    .navbtn{
      width:44px;
      height:44px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:18px;
      cursor:pointer;
      user-select:none;
    }
    .navbtn:hover{ background: rgba(255,255,255,.06); }
    .navbtn:active{ transform: translateY(1px); }
    .navbtn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Calendar */
    .calendar{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
    }

    .dow{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .dow div{
      padding:10px 6px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
      letter-spacing: .3px;
      min-width: 0;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      padding:10px;
      gap:8px;
    }

    .cell{
      border-radius: var(--cell-radius);
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.15);
      padding:8px;
      position:relative;
      cursor:pointer;
      user-select:none;
      min-width: 0;
      height: 62px;
      overflow:hidden;
    }
    .cell:hover{ background: rgba(255,255,255,.04); }
    .cell:active{ transform: translateY(1px); }
    .cell.blank{ background:transparent; border:none; cursor:default; }

    .cell.selected{
      outline:2px solid rgba(255,255,255,.40);
      outline-offset:1px;
    }

    /* persistent treatments across BOTH views */
    .cell.best{
      box-shadow: 0 0 0 9999px var(--bestGlow) inset;
      border-color: rgba(245,158,11,.35);
    }
    .cell.confirmed{
      box-shadow: 0 0 0 9999px var(--confirmGlow) inset;
      border-color: rgba(34,197,94,.35);
    }
    .cell.blocked{
      box-shadow: 0 0 0 9999px var(--blockedFill) inset;
      border-color: rgba(239,68,68,.30);
    }

    /* day number */
    .num{
      font-size:12px;
      font-weight:900;
      opacity:.95;
    }
    .num.blockedNum{
      color: rgba(239,68,68,.95);
    }

    /* MY view: single status dot */
    .status-chip{
      position:absolute;
      left:8px;
      bottom:8px;
      width:10px;
      height:10px;
      border-radius:50%;
    }

    /* GROUP view layout: left number, right sextuplet dots */
    .cell-inner{
      display:grid;
      grid-template-columns: 22px 1fr;
      align-items:center;
      gap:8px;
      height: 100%;
    }

    .dot6{
      display:grid;
      grid-template-columns: repeat(3, 10px);
      grid-auto-rows: 10px;
      gap:4px;
      justify-content:flex-end;
      align-content:center;
    }

    .dot{
      width:10px;
      height:10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.03); /* empty */
    }

    /* Actions (MY view) */
    .actions{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-auto-rows: 52px;
      gap:10px;
    }

    .action{
      height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      color: #0b0f14;
      letter-spacing: .2px;
    }
    .action:disabled{ opacity:.45; cursor:not-allowed; }
    .action:active{ transform: translateY(1px); }

    .green{ background:var(--green); }
    .blue{ background:var(--blue); }
    .yellow{ background:var(--yellow); }
    .red{ background:var(--red); }

    .clear{
      grid-column: 1 / span 2;
      background: rgba(255,255,255,.12);
      color: #ffffff;
      border: 1px solid rgba(255,255,255,.18);
    }
    .clear:hover{ background: rgba(255,255,255,.16); }

    /* Legend (group view) */
    .legend{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      display:none;
      font-size: 13px;
      color: rgba(255,255,255,.85);
      line-height: 1.35;
    }
    .legend.show{ display:block; }
    .legend .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 8px;
    }
    .legend .chip{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight: 900;
      white-space: nowrap;
    }

    /* Modal base */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }

    .modal{
      width:min(560px, 100%);
      border-radius:20px;
      background: rgba(17,24,39,.95);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:16px;
      position:relative;
    }

    .modal h2{
      margin: 0 0 12px;
      font-size:18px;
      letter-spacing: .2px;
      padding-right: 42px;
    }

    .xbtn{
      position:absolute;
      top:12px;
      right:12px;
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      color:#fff;
      cursor:pointer;
      font-size:20px;
      font-weight: 900;
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .xbtn:hover{ background: rgba(0,0,0,.28); }
    .xbtn:active{ transform: translateY(1px); }

    /* Character picker */
    .char-grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:520px){ .char-grid{ grid-template-columns:1fr 1fr; } }
    .char-btn{
      border-radius:16px;
      border:none;
      padding:16px;
      min-height:56px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:16px;
      letter-spacing:.3px;
      color:#ffffff;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.15), 0 6px 18px rgba(0,0,0,.35);
    }
    .char-btn:hover{ filter: brightness(1.05); }
    .char-btn:active{ transform: translateY(1px); filter: brightness(0.95); }

    /* Group date modal */
    .people-list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .person-line{
      display:flex;
      gap:10px;
      align-items:baseline;
      flex-wrap: wrap;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 10px 12px;
      border-radius: 14px;
    }
    .pname{
      font-weight: 900;
      letter-spacing:.2px;
      white-space: nowrap;
    }
    .pstatus{
      color: rgba(255,255,255,.92);
      font-weight: 700;
      overflow-wrap:anywhere;
    }

    .g-actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .g-action{
      height: 52px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      color:#0b0f14;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .g-action:active{ transform: translateY(1px); }

    .g-block{ background: var(--red); }
    .g-unblock{
      background: rgba(255,255,255,.12);
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
    }
    .g-confirm{ background: var(--green); }
    .g-clock{
      grid-column: 1 / span 2;
      background: rgba(255,255,255,.12);
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
    }
    .g-cancel{
      grid-column: 1 / span 2;
      background: rgba(255,255,255,.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,.16);
    }

    /* Loading overlay */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1200;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding: 18px;
    }
    .overlay-card{
      width:min(420px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(17,24,39,.95);
      box-shadow: var(--shadow);
      padding: 16px;
      text-align:center;
      font-weight: 900;
      letter-spacing: .2px;
    }

    /* Confirm time modal */
    .timebox{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 8px;
    }
    .time-title{
      font-weight: 900;
      font-size: 16px;
    }
    .time-date{
      color: rgba(255,255,255,.85);
      font-weight: 800;
      margin-top: -4px;
    }
    .time-input{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: #fff;
      padding: 14px 12px;
      font-size: 16px;
      font-weight: 800;
      outline: none;
    }
    .time-input::placeholder{ color: rgba(255,255,255,.55); font-weight: 800; }

    .time-check{
      position:absolute;
      top:12px;
      right:12px;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(34,197,94,.20);
      color:#fff;
      cursor:pointer;
      font-size: 20px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .time-check:hover{ background: rgba(34,197,94,.28); }
    .time-check:active{ transform: translateY(1px); }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.50);
      color: #fff;
      font-weight: 900;
      letter-spacing: .2px;
      display:none;
      z-index: 1300;
      max-width: calc(100vw - 24px);
      text-align:center;
    }

    /* Mobile tuning: smaller gap so 7 columns fit */
    @media (max-width: 390px){
      .grid{ gap:6px; padding: 8px; }
      .cell{ height: 58px; padding: 7px; }
      .cell-inner{ grid-template-columns: 20px 1fr; gap:6px; }
      .dot6{ grid-template-columns: repeat(3, 9px); grid-auto-rows: 9px; gap:3px; }
      .dot{ width:9px; height:9px; }
      .dow div{ font-size: 11px; padding: 8px 4px; }
      .banner-title{ font-size: 19px; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="banner" id="banner">
    <div class="banner-left">
      <div class="banner-title" id="bannerTitle">Pick a character</div>

      <div class="banner-subrow">
        <button class="modebtn active" id="btnMy" type="button">
          <span class="icon">üë§</span>
          <span>My Availability</span>
        </button>
        <button class="modebtn" id="btnGroup" type="button">
          <span class="icon">üë•</span>
          <span>Group Availability</span>
        </button>
      </div>
    </div>

    <div class="banner-right">
      <span class="pill" id="selectedPill">
        <span id="selectedCount">0 dates selected</span>
        <span class="pill-x" id="clearSelectedX" title="Clear selected">√ó</span>
      </span>
      <button class="reset" id="changeChar" type="button">Change</button>
    </div>
  </div>

  <div class="monthbar">
    <div class="month-title" id="monthTitle">
      <span id="monthLabel"></span>
      <span class="loading-tag" id="loadingTag">Loading‚Ä¶</span>
    </div>

    <div class="navbtns">
      <button class="navbtn" id="prev" type="button" aria-label="Previous month">‚Äπ</button>
      <button class="navbtn" id="next" type="button" aria-label="Next month">‚Ä∫</button>
    </div>
  </div>

  <div class="calendar" id="calendar">
    <div class="dow">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
      <div>Thu</div><div>Fri</div><div>Sat</div>
    </div>
    <div class="grid" id="grid"></div>
  </div>

  <!-- MY view actions -->
  <div class="actions" id="actions">
    <button class="action green" id="avail" disabled type="button">Available</button>
    <button class="action blue" id="virt" disabled type="button">Virtual Only</button>
    <button class="action yellow" id="maybe" disabled type="button">Maybe</button>
    <button class="action red" id="unavail" disabled type="button">Unavailable</button>
    <button class="action clear" id="clearStatus" disabled type="button">Clear Status</button>
  </div>

  <!-- GROUP legend -->
  <div class="legend" id="legend">
    <div style="font-weight:900; margin-bottom:6px;">How ‚Äúbest dates‚Äù are chosen</div>
    <div>
      Score per person: <b>Available</b> +3, <b>Virtual</b> +2, <b>Maybe</b> +1, <b>Unknown</b> 0, <b>Unavailable</b> ‚àí3.
    </div>
    <div style="margin-top:6px;">
      Yellow glow = highest-scoring date(s) in the month <b>with at least 4 people weighed in</b>.
    </div>
    <div class="row">
      <span class="chip">Green glow = confirmed date (per month)</span>
      <span class="chip">Red tint + red day # = blocked date</span>
    </div>
  </div>

</div>

<!-- Character Modal -->
<div class="modal-backdrop" id="modalChar">
  <div class="modal">
    <button class="xbtn" id="closeChar" type="button">√ó</button>
    <h2>Who are you?</h2>
    <div class="char-grid" id="charGrid"></div>
  </div>
</div>

<!-- Loading Overlay (for initial + month switch loads) -->
<div class="overlay" id="overlay">
  <div class="overlay-card" id="overlayText">Loading‚Ä¶</div>
</div>

<!-- Group Date Modal -->
<div class="modal-backdrop" id="modalGroupDate">
  <div class="modal">
    <button class="xbtn" id="closeGroupDate" type="button">√ó</button>
    <h2 id="gdTitle">Wed, Dec 17</h2>

    <div class="people-list" id="gdPeople"></div>

    <div class="g-actions" id="gdActions">
      <button class="g-action g-block" id="btnBlockDate" type="button">üö´ Block date</button>
      <button class="g-action g-confirm" id="btnConfirmDate" type="button">‚úÖ Confirm date</button>

      <button class="g-action g-clock" id="btnTime" type="button">üïí Add a time</button>
      <button class="g-action g-cancel" id="btnCancelConfirm" type="button">‚úñ Cancel confirmation</button>

      <button class="g-action g-unblock" id="btnUnblockDate" type="button">‚Üª Make date available</button>
    </div>
  </div>
</div>

<!-- Confirm Time Modal -->
<div class="modal-backdrop" id="modalTime">
  <div class="modal">
    <button class="time-check" id="timeSave" type="button" title="Save">‚úì</button>
    <h2>Confirming December Date</h2>

    <div class="timebox">
      <div class="time-date" id="timeDateLabel">Wed, Dec 12</div>
      <input class="time-input" id="timeInput" type="text" placeholder="what time? (Optional)" />
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script src="./app.js"></script>
</body>
</html>
